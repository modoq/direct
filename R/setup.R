# ============================================================================
# Setup Functions for Direct Package
# ============================================================================

#' Initialize Direct in Current Project
#' 
#' Creates a .Rprofile and .Rproj file in the current project directory that loads
#' the direct package and starts the MCP server when the project is opened.
#' Also creates .direct/config.yml for audit configuration.
#' 
#' @param force Logical indicating whether to overwrite existing .Rprofile (default: FALSE)
#' @param project_name Optional project name (default: basename of current directory)
#' @return Invisible NULL
#' @export
#' @examples
#' \dontrun{
#' # Initialize direct in your project
#' init_project()
#' 
#' # With custom project name
#' init_project(project_name = "my-analysis")
#' 
#' # Force overwrite existing .Rprofile
#' init_project(force = TRUE)
#' }
init_project <- function(force = FALSE, project_name = NULL) {
  
  project_dir <- getwd()
  rprofile_path <- file.path(project_dir, ".Rprofile")
  
  # Determine project name
  if (is.null(project_name)) {
    project_name <- basename(project_dir)
  }
  
  rproj_path <- file.path(project_dir, paste0(project_name, ".Rproj"))
  
  # Check if .Rprofile already exists
  if (file.exists(rprofile_path) && !force) {
    message("âš ï¸  .Rprofile already exists in this project!")
    message("   Use init_project(force = TRUE) to overwrite")
    message("   Current file: ", rprofile_path)
    return(invisible(NULL))
  }
  
  # Get template from inst/templates
  template_path <- system.file("templates", ".Rprofile", package = "direct")
  
  if (!file.exists(template_path)) {
    # Fallback: create template directly
    template_content <- c(
      "# Direct MCP Server Configuration",
      "# Auto-generated by direct::init_project()",
      "",
      "# Load required packages",
      "suppressPackageStartupMessages({",
      "  library(direct)",
      "  library(mcptools)",
      "})",
      "",
      "# Start MCP server with direct tools",
      "mcptools::mcp_session()",
      "",
      "# Welcome message",
      "cat('\\nâœ… Direct MCP server started\\n')",
      "cat('ðŸ“ Workspace:', getwd(), '\\n')",
      "cat('ðŸ›¡ï¸  Security features active\\n\\n')"
    )
  } else {
    template_content <- readLines(template_path)
  }
  
  # Write .Rprofile
  writeLines(template_content, rprofile_path)
  
  # Create .Rproj file if it doesn't exist
  if (!file.exists(rproj_path)) {
    rproj_content <- c(
      "Version: 1.0",
      "",
      "RestoreWorkspace: Default",
      "SaveWorkspace: Default",
      "AlwaysSaveHistory: Default",
      "",
      "EnableCodeIndexing: Yes",
      "UseSpacesForTab: Yes",
      "NumSpacesForTab: 2",
      "Encoding: UTF-8",
      "",
      "RnwWeave: Sweave",
      "LaTeX: pdfLaTeX"
    )
    writeLines(rproj_content, rproj_path)
    message("âœ… Created: ", basename(rproj_path))
  } else {
    message("â„¹ï¸  .Rproj file already exists: ", basename(rproj_path))
  }
  
  # Initialize audit configuration
  init_audit_config()
  
  message("âœ… Project initialized successfully!")
  message("ðŸ“ Created: ", rprofile_path)
  if (!file.exists(rproj_path)) {
    message("ðŸ“ Created: ", basename(rproj_path))
  }
  message("ðŸ“ Created: .direct/config.yml")
  message("")
  message("Next steps:")
  message("  1. Close and reopen this project in RStudio")
  message("     File â†’ Recent Projects â†’ ", basename(rproj_path))
  message("  2. Run show_claude_config() to get Claude Desktop configuration")
  message("  3. Add the configuration to Claude Desktop settings")
  message("  4. Restart Claude Desktop")
  
  invisible(NULL)
}

#' Show Claude Desktop MCP Configuration
#' 
#' Displays the JSON configuration snippet that needs to be added to
#' Claude Desktop's config file.
#' 
#' @param project_path Optional path to project (default: current directory)
#' @return Invisible character string with JSON configuration
#' @export
#' @examples
#' \dontrun{
#' # Show configuration for current project
#' show_claude_config()
#' 
#' # Show configuration for specific project
#' show_claude_config("/path/to/my/project")
#' }
show_claude_config <- function(project_path = getwd()) {
  
  project_path <- normalizePath(project_path, mustWork = FALSE)
  
  # Create JSON configuration
  # Use Rscript and the new start_mcp_server() function
  config <- '{
  "mcpServers": {
    "r-direct": {
      "command": "Rscript",
      "args": [
        "-e",
        "direct::start_mcp_server()"
      ]
    }
  }
}'
  
  message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
  message("ðŸ“‹ CLAUDE DESKTOP CONFIGURATION")
  message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
  message("")
  message("1. Open Claude Desktop configuration:")
  message("   - macOS: ~/Library/Application Support/Claude/claude_desktop_config.json")
  message("   - Windows: %APPDATA%\\Claude\\claude_desktop_config.json")
  message("   - Linux: ~/.config/Claude/claude_desktop_config.json")
  message("")
  message("2. Add or merge this configuration:")
  message("")
  cat(config)
  message("")
  message("")
  message("3. Save the file and restart Claude Desktop")
  message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
  
  invisible(config)
}

#' Check Direct Setup
#' 
#' Verifies that direct and required packages are properly installed and
#' the MCP server is configured correctly.
#' 
#' @return Invisible list with check results
#' @export
#' @examples
#' \dontrun{
#' # Check if everything is set up correctly
#' check_setup()
#' }
check_setup <- function() {
  
  results <- list(
    direct_installed = FALSE,
    mcptools_installed = FALSE,
    ellmer_installed = FALSE,
    rprofile_exists = FALSE,
    rstudio_available = FALSE
  )
  
  message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
  message("ðŸ” CHECKING DIRECT SETUP")
  message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
  message("")
  
  # Check direct
  if (requireNamespace("direct", quietly = TRUE)) {
    results$direct_installed <- TRUE
    message("âœ… direct package installed")
  } else {
    message("âŒ direct package NOT installed")
  }
  
  # Check mcptools
  if (requireNamespace("mcptools", quietly = TRUE)) {
    results$mcptools_installed <- TRUE
    message("âœ… mcptools package installed")
  } else {
    message("âŒ mcptools package NOT installed")
    message("   Install with: install.packages('mcptools')")
  }
  
  # Check ellmer
  if (requireNamespace("ellmer", quietly = TRUE)) {
    results$ellmer_installed <- TRUE
    message("âœ… ellmer package installed")
  } else {
    message("âŒ ellmer package NOT installed")
    message("   Install with: install.packages('ellmer')")
  }
  
  # Check .Rprofile
  rprofile_path <- file.path(getwd(), ".Rprofile")
  if (file.exists(rprofile_path)) {
    results$rprofile_exists <- TRUE
    message("âœ… .Rprofile exists in project")
  } else {
    message("âš ï¸  .Rprofile NOT found in project")
    message("   Run: init_project()")
  }
  
  # Check RStudio
  if (requireNamespace("rstudioapi", quietly = TRUE) && rstudioapi::isAvailable()) {
    results$rstudio_available <- TRUE
    message("âœ… RStudio available")
  } else {
    message("âš ï¸  RStudio not available (some features require RStudio)")
  }
  
  message("")
  message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
  
  # Check if packages are OK
  packages_ok <- all(unlist(results[c("direct_installed", "mcptools_installed", "ellmer_installed")]))
  
  # Check if project is initialized
  project_ok <- results$rprofile_exists
  
  if (packages_ok && project_ok) {
    message("âœ… Setup complete and ready to use!")
  } else if (packages_ok && !project_ok) {
    message("âš ï¸  Packages installed, but project not initialized")
    message("   Run: init_project()")
  } else {
    message("âš ï¸  Some packages missing - see above for details")
  }
  
  message("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
  
  invisible(results)
}
